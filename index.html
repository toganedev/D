<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>曲再生サイト</title>

  <!-- サイトアイコン -->
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/toganedev/D/main/discord_icon.png">

  <!-- スマホ用ホーム画面アイコン -->
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/toganedev/D/main/discord_icon.png">

  <!-- PWA用マニフェスト -->
  <link rel="manifest" href="manifest.json">

  <style>
    body {
      background-color: #f7f3e9;
      font-family: sans-serif;
      color: #333;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #8bbccc;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #fff;
    }
    header h1 {
      margin: 0;
    }
    .creator-card {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .creator-card img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
    }
    main {
      max-width: 900px;
      margin: auto;
      padding: 1.5rem;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      margin: 0.4rem 0;
    }
    a {
      color: #5a7d9a;
      text-decoration: none;
      font-weight: bold;
    }
    a:hover {
      text-decoration: underline;
    }
    audio {
      width: 100%;
      margin-top: 1.5rem;
    }
    .controls {
      margin-bottom: 1rem;
      display: flex;
      gap: 0.5rem;
    }
    .controls button {
      background-color: #8bbccc;
      border: none;
      color: white;
      padding: 0.4rem 0.8rem;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
    }
    .controls button:hover {
      background-color: #7aa9b6;
    }
    .search-bar {
      margin-bottom: 1rem;
    }
    .search-bar input {
      padding: 0.4rem;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
    }
    #auth {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    #auth input {
      padding: 8px;
      margin-top: 8px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #auth button {
      padding: 8px 14px;
      margin-top: 8px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #8bbccc;
      color: #fff;
    }
    .now-playing {
      margin-top: 1rem;
      font-weight: bold;
    }
    .up-next {
      margin-top: 0.3rem;
      font-size: 14px;
      color: #666;
    }
  </style>
</head>
<body>

<div id="auth">
  <h2>パスワードを入力してください</h2>
  <input type="password" id="password" placeholder="Password">
  <button onclick="checkPassword()">送信</button>
</div>

<div id="main-content" style="display:none;">
  <header>
    <h1>曲再生サイト</h1>
    <div class="creator-card">
      <img src="https://raw.githubusercontent.com/toganedev/D/main/discord_icon.png" alt="icon">
      <div>
        <div>togane_dev</div>
        <div style="font-size:12px;">1401421639106957464</div>
      </div>
    </div>
  </header>
  <main>
    <div class="controls">
      <button onclick="playRandom()">ランダム</button>
      <button onclick="prevTrack()">戻る</button>
      <button onclick="nextTrack()">スキップ</button>
      <button onclick="toggleRepeat()" id="repeat-btn">リピートOFF</button>
    </div>
    <div class="search-bar">
      <input type="text" id="search" placeholder="曲名検索..." oninput="filterTracks()">
    </div>
    <div class="now-playing" id="now-playing">再生中: なし</div>
    <div class="up-next" id="up-next">次の曲: なし</div>
    <h2>曲一覧</h2>
    <ul id="track-list">読み込み中...</ul>
    <audio id="player" controls></audio>
  </main>
</div>

<script>
let tracks = [];
let filteredTracks = [];
let currentIndex = 0;
let isRepeat = false; // 1曲リピートモード
const repoOwner = "toganedev";
const repoName = "D";
const baseURL = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/`;

async function checkPassword() {
  const input = document.getElementById("password").value.trim();
  const res = await fetch(baseURL + "password.txt");
  const text = await res.text();
  const lines = text.split(/\r?\n/).map(l => l.trim());
  if (lines.includes(input)) {
    document.getElementById("auth").style.display = "none";
    document.getElementById("main-content").style.display = "block";
    loadTracks();
  } else {
    alert("パスワードが違います");
  }
}

document.getElementById("password").addEventListener("keydown", e => {
  if (e.key === "Enter") {
    checkPassword();
  }
});

async function loadTracks() {
  const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents`);
  const files = await res.json();
  tracks = files
    .filter(file => file.name.endsWith(".mp4") || file.name.endsWith(".m4a"))
    .map(file => decodeURIComponent(file.name));
  filteredTracks = [...tracks];
  renderTrackList();
}

function renderTrackList() {
  const listContainer = document.getElementById("track-list");
  listContainer.innerHTML = "";
  filteredTracks.forEach((file, index) => {
    const li = document.createElement("li");
    const link = document.createElement("a");
    link.href = "#";
    link.textContent = file;
    link.addEventListener("click", e => {
      e.preventDefault();
      playTrack(filteredTracks.indexOf(file));
    });
    li.appendChild(link);
    listContainer.appendChild(li);
  });
}

function playTrack(index) {
  if (index < 0 || index >= filteredTracks.length) return;
  currentIndex = index;
  const trackName = filteredTracks[index];
  const player = document.getElementById("player");
  player.src = baseURL + encodeURIComponent(trackName);
  player.play();
  updateNowPlaying();

  // リピート処理
  player.onended = () => {
    if (isRepeat) {
      player.currentTime = 0; // 曲の先頭に戻す
      player.play();
    } else {
      nextTrack();
    }
  };
}

function updateNowPlaying() {
  const now = filteredTracks[currentIndex] || "なし";
  const next = filteredTracks[(currentIndex + 1) % filteredTracks.length] || "なし";
  document.getElementById("now-playing").textContent = "再生中: " + now;
  document.getElementById("up-next").textContent = "次の曲: " + next;
}

function nextTrack() {
  playTrack((currentIndex + 1) % filteredTracks.length);
}

function prevTrack() {
  playTrack((currentIndex - 1 + filteredTracks.length) % filteredTracks.length);
}

function playRandom() {
  const randomIndex = Math.floor(Math.random() * filteredTracks.length);
  playTrack(randomIndex);
}

function filterTracks() {
  const query = document.getElementById("search").value.toLowerCase();
  filteredTracks = tracks.filter(t => t.toLowerCase().includes(query));
  renderTrackList();
}

function toggleRepeat() {
  isRepeat = !isRepeat;
  document.getElementById("repeat-btn").textContent = isRepeat ? "リピートON" : "リピートOFF";
}
</script>
</body>
</html>
